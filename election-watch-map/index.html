<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>European Election Watch</title>
		<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
		<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="//d3js.org/topojson.v1.min.js"></script>
		<script src="https://apis.google.com/js/api.js"></script>
		<style type="text/css">


			svg {
				background-color: #d2e4f2;
			}

			h1 {
				color: rgb(115, 115, 115);
				font-size: 18px;
				font-family: sans-serif;
				font-weight: bold;
				margin: 0;
				padding-bottom: 10px;

			}

			#container {
				width: 800px;
				margin-left: auto;
				margin-right: auto;
				margin-top: 20px;
				padding: 20px;
			}

			path.hasData {
				opacity: 0.9;
			}

			path.hasData:hover {
				cursor:pointer;
				opacity: 1;
			}

			.legend-container {
				fill: #fff;
				opacity: 0.8;
				height: 30px;
				width: 50%;
			}



		</style>
	</head>
	<body>


	<div id="container"></div>
		

		<script type="text/javascript">
			// Data Object
			var data = {};
			var electionTypes = [];

			// Load in JSON for Country Data
			function start() {
			  // 2. Initialize the JavaScript client library.
			  gapi.client.init({
			    'apiKey': 'AIzaSyCeoG8raQ3YkU-PENVFvoR6yu5V2AusvFs',
			  }).then(function() {
			    // 3. Initialize and make the API request.
			    return gapi.client.request({
			        'path': 'https://sheets.googleapis.com/v4/spreadsheets/19VO_oRGGOe6MhP3SHC-yGB8kVL8ka6me6rSeTbAmj48/values/A:E'
			    })
			  }).then(function(response) {
			    // Loop through rows
			    $.each(response.result.values, function(index, value) {
			    	if(index > 0) {
				        data[value[1]] = {
				        	name: value[0],
				        	type: value[2],
				        	date: value[3],
				        	url: value[4]
				        }

				        if(electionTypes.indexOf(value[2]) == -1) {
				        	electionTypes.push(value[2]);
				        }
				    }
			    });
			  }, function(reason) {
			    console.log('Error: ' + reason.result.error.message);
			  }).then(function() {
			  	console.log(data);
			  	// Render SVG
			  	drawSVG();
			  });
			};
			// 1. Load the JavaScript client library.
			gapi.load('client', start);

			function drawSVG() {
				//Width and height
				var width = 800;
				var height = 600;

				// Color Scales
				var color = d3.scale.ordinal()
			      .domain(electionTypes)
			      .range(['#381217', '#832434', '#cb8595']);

				//Define map projection
				var projection = d3.geo.mercator() //utiliser une projection standard pour aplatir les p√¥les, voir D3 projection plugin
									   .center([ 13, 52 ]) //comment centrer la carte, longitude, latitude
									   .translate([ width/2, height/2 ]) // centrer l'image obtenue dans le svg
									   .scale([ width/1.5 ]); // zoom, plus la valeur est petit plus le zoom est gros 

				//Define path generator
				var path = d3.geo.path()
								 .projection(projection);


				//Create SVG
				var svg = d3.select("#container")
							.append("svg")
							.attr("width", width)
							.attr("height", height);

				//Load in GeoJSON data
				d3.json("world.json", function(json) {
					// Draw individual country paths
					svg.append("g").selectAll("path")
						.data(json.features)
						.enter()
							.append("path")
					   		.attr("d", path)
					   		.attr("id", function(d) {return d.properties.iso_a3;})
					   		.attr("class", function(d) {
					   			if(data[d.properties.iso_a3] != undefined) {
					   				return "hasData";
					   			}
					   		})
					   		.attr("stroke", "#cebe98")
					   		.attr("fill", function(d) {
					   			if(data[d.properties.iso_a3] != undefined) {
					   				return color(data[d.properties.iso_a3].type);
					   			}
					   			else {
					   				return "#ffedc1";
					   			}
					   		})
					   	.on("mouseover", function(d) {
					   		d3.select(this).transition().duration(300);
					   	})
					   	.on("mouseout", function(d) {
					   		d3.select(this).transition().duration(300);
					   	})
					   	.on("click", function(d) {
					   		if(data[d.properties.iso_a3] != undefined) {
				   				location.href = data[d.properties.iso_a3].url;
				   			}
					   	});

					svg.append("g")
						.append("rect")
							.attr("class", "legend-container")
							.style("transform", "translate("+(width/2)+"px, "+(height - 30)+"px)");

					// svg.selectAll(".subunit-label")
					//     .data(json.features)
					//   .enter().append("text")
					//     .attr("class", function(d) { return "subunit-label " + d.id; })
					//     .attr("transform", function(d) { if(d.properties.continent == "Europe") { console.log(d.properties.name); console.log(path.centroid(d)); return "translate(" + path.centroid(d) + ")"; }})
					//     .attr("dy", ".35em")
					//     .text(function(d) { if(d.properties.continent == "Europe") { return d.properties.abbrev; }});
			
				});
			}

		</script>
	</body>
</html>